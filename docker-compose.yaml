networks:
  duck-network:
    driver: bridge

volumes:
  rabbitmq_data:
  postgres-data:
  pgadmin-data:
  kong-postgres:


services:
  # IMDTravel Microservice
  kong-database:
    image: postgres:15-alpine
    deploy:
      restart_policy:
        condition: any
    networks:
      - duck-network
    environment:
      - POSTGRES_USER=kong
      - POSTGRES_DB=kong
      - POSTGRES_PASSWORD=kong
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U kong -d kong" ]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - kong-postgres:/var/lib/postgresql/data

  ###
  ### Kong Migrations
  ### Container para executar as migrations do Kong API Gateway
  ###
  kong-migrations:
    image: kong:latest
    container_name: kong-migrations
    depends_on:
      kong-database:
        condition: service_healthy
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-database
      - KONG_PG_USER=kong
      - KONG_PG_PASSWORD=kong
      - KONG_PG_DATABASE=kong
    command: ["kong", "migrations", "bootstrap"]
    networks:
      - duck-network


  ###
  ### Kong API Gateway
  ### Container com o runtime do Kong API Gateway
  ###
  kong:
    build:
      context: .
      dockerfile: Dockerfile.kong
    depends_on:
      - kong-database
      - kong-migrations
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-database
      - KONG_PG_USER=kong
      - KONG_PG_PASSWORD=kong
      - KONG_PG_DATABASE=kong
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
    ports:
      - "8000:8000"  # proxy
      - "8443:8443"  # proxy SSL
      - "8001:8001"  # admin API
      - "8444:8444"  # admin API SSL
    networks:
      - duck-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
  kong-configurator:
    image: kong/deck:latest
    depends_on:
      - kong
      - kong-database
      - kong-migrations
      - imdtravel
      - airlineshub
      - exchange
      - fidelity
      - auth
    volumes:
      - ./kong-config/kong-declarative-config.yml:/config/kong-declarative-config.yml:ro
    command: gateway sync /config/kong-declarative-config.yml --kong-addr=http://kong:8001
    networks:
      - duck-network
    restart: always
    

  ###
  ### Konga
  ### Administracao via interface web do Kong API Gateway
  ###
  konga:
    image: pantsel/konga
    networks:
      - duck-network
    deploy:
      restart_policy:
        condition: on-failure
    depends_on:
      - kong
    environment:
      - KONGA_DB_ADAPTER=postgres
      - KONGA_DB_HOST=kong-database
      - KONGA_DB_USER=kong
      - KONGA_DB_PASSWORD=kong
      - KONGA_DB_DATABASE=kong
      - NODE_ENV=development
    ports:
      - "1337:1337"
    restart: always

  ## ABAIXO TEM OS MICROSERVICOS DA APLICACAO ##

  imdtravel:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: imdtravel-service
    ports:
      - "3000:3000"
    env_file:
      - .env.docker
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/imdtravel/node_modules
      - /app/apps/imdtravel/prisma/generated
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - duck-network
    command: bash /app/scripts/init-imdtravel.sh

  # AirlinesHub Microservice
  airlineshub:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: airlineshub-service
    ports:
      - "3001:3001"
    env_file:
      - .env.docker
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/airlineshub/node_modules
      - /app/apps/airlineshub/prisma/generated
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - duck-network
    command: bash /app/scripts/init-airlineshub.sh

  # Exchange Microservice
  exchange:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: exchange-service
    ports:
      - "3002:3002"
    env_file:
      - .env.docker
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/exchange/node_modules
    networks:
      - duck-network

    command: bash /app/scripts/init-exchange.sh

  # Fidelity Microservice
  fidelity:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: fidelity-service
    ports:
      - "3003:3003"
    env_file:
      - .env.docker
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/fidelity/node_modules
    networks:
      - duck-network
    command: bash /app/scripts/init-fidelity.sh

  # Auth Microservice
  auth:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: auth-service
    ports:
      - "3004:3004"
    env_file:
      - .env.docker
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/auth/node_modules
      - /app/apps/auth/prisma/generated
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - duck-network
    command: bash /app/scripts/init-auth.sh

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: quack-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: quack
      POSTGRES_PASSWORD: quack
      POSTGRES_MULTIPLE_DATABASES: "imdtravel,airlineshub,fidelity,auth"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quack"]
      interval: 2s
      timeout: 1s
      retries: 20
    networks:
      - duck-network
    
  
  redis:
    image: redis
    command: redis-server --requirepass Redis2019!
    ports:
      - "6379:6379"
    networks:
      - duck-network

  # PgAdmin for Database Management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: quack-pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on:
      - postgres
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - duck-network
  rabbitmq:
    # image: rabbitmq:3-management
    build:
      context: .
      dockerfile: docker/rabbitmq/Dockerfile
    ports:
      - '5672:5672'
      - '15672:15672'
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - duck-network
    healthcheck:
      test: ["CMD", "rabbitmqctl", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s


